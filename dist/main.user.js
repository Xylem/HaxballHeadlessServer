// ==UserScript==
// @name Haxball Headless Server
// @version 0.7.0
// @author Xylem
// @match https://*.haxball.com/headless
// ==/UserScript==

function main(){!function(e){var t={};function s(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(r,i,function(t){return e[t]}.bind(null,i));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){const r=s(1);function i(e,t){const s=document.createElement("button");s.innerHTML=`Set ${e}`,s.addEventListener("click",()=>(function(e,t){window.localStorage.setItem(e,window.prompt(t))})(t,`Provide new ${e}`)),document.body.prepend(s)}i("room password","password"),i("room name","roomName"),window.onHBLoaded=()=>{const e=window.localStorage.getItem("roomName")||"Headless Server Room",t=window.localStorage.getItem("password")||void 0,i=HBInit({roomName:e,maxPlayers:100,public:!1,noPlayer:!0,password:t}),o=new r.Server(i),a={};function n(e,t){"onPlayerChat"!==e?(i[e]||(i[e]=(...t)=>{a[e].forEach(e=>e(...t))}),a[e]||(a[e]=[]),a[e].push(t)):console.error("Direct interception of chat not allowed.")}function h(e,t){for(const[s,r]of Object.entries(t||{}))for(const t of r)n(s,e[t].bind(e))}function d(e){const{plugin:t,hooks:r,commands:i}=s(2)(`./${e}/plugin`),a=new t(o);h(a,r);for(const[e,t]of Object.entries(i||{}))o.addCommand(a,e,t)}h(o,r.hooks),d("Help"),d("ScoreTracking"),d("ReadyPlayers"),d("Vote"),d("AnnounceWinners"),d("ReconnectToMatch"),d("StatsGathering")}},function(e,t){e.exports={Server:class{constructor(e){this.room=e,this.redTeam=new Set,this.blueTeam=new Set,this.playerAuth={},this.gameStarted=!1,this.commands={},this.setStadium("Huge"),this.setScoreLimit(3),this.setTimeLimit(5),this.room.setTeamsLock(!0),this.room.onPlayerChat=(e,t)=>{if(!t.startsWith("!"))return!0;const s=t.split(" "),r=s.shift().substring(1);return this.commands[r]?(this.commands[r].action(e,...s),!1):(this.sendChat(`Command !${r} does not exist`,e.id),!0)}}static get allowedStadiums(){return new Set(["Classic","Easy","Small","Big","Rounded","Hockey","Big Hockey","Big Easy","Big Rounded","Huge"])}rememberPlayerAuth(e){this.playerAuth[e.id]=e.auth}deletePlayerAuth(e){delete this.playerAuth[e.id]}get players(){return this.room.getPlayerList().map(e=>({...e,auth:this.playerAuth[e.id]}))}setStadium(e){this.gameStarted||(this.stadium=e,this.room.setDefaultStadium(e))}setTimeLimit(e){this.gameStarted||(this.timeLimit=e,this.room.setTimeLimit(e))}setScoreLimit(e){this.gameStarted||(this.scoreLimit=e,this.room.setScoreLimit(e))}startGame(){if(this.gameStarted)return;const{players:e}=this;this.gameStarted=!0,e.sort(()=>Math.random()-.5),e.forEach((e,t)=>{const s=t%2+1;this.room.setPlayerTeam(e.id,s),1===s?this.redTeam.add(e.auth):this.blueTeam.add(e.auth)}),this.room.startGame()}sendChat(e,t){this.room.sendAnnouncement(e,t,10559239,"italic",0)}addCommand(e,t,s){this.commands[t]={action:e[t].bind(e),help:s.help,usage:s.usage}}stopGameIfTeamIsEmpty(){if(this.gameStarted){const{players:e}=this,t=e.filter(e=>1===e.team),s=e.filter(e=>2===e.team);0!==t.length&&0!==s.length||this.stopGame()}}stopGame(){this.gameStarted=!1,this.players.forEach(e=>{this.room.setPlayerTeam(e.id,0)}),this.redTeam.clear(),this.blueTeam.clear(),this.room.stopGame()}},hooks:{onPlayerJoin:["rememberPlayerAuth"],onPlayerLeave:["stopGameIfTeamIsEmpty","deletePlayerAuth"],onGameStop:["stopGame"]}}},function(e,t,s){var r={"./AnnounceWinners/plugin":3,"./Help/plugin":4,"./ReadyPlayers/plugin":5,"./ReconnectToMatch/plugin":6,"./ScoreTracking/plugin":7,"./StatsGathering/plugin":8,"./Vote/plugin":9};function i(e){var t=o(e);return s(t)}function o(e){if(!s.o(r,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return r[e]}i.keys=function(){return Object.keys(r)},i.resolve=o,e.exports=i,i.id=2},function(e,t){e.exports={plugin:class{constructor(e){this.server=e}announce(e){let t;t=e.red>e.blue?1:2;const s=this.server.players.filter(e=>e.team===t);this.server.sendChat(`Winners: ${s.map(e=>e.name).join(", ")}`)}},hooks:{onTeamVictory:["announce"]}}},function(e,t){e.exports={plugin:class{constructor(e){this.server=e}greet(e){this.server.sendChat("Say `!help` for help",e.id)}help(e,t){if(!t)return this.server.sendChat("Say:",e.id),void Object.keys(this.server.commands).forEach(t=>{this.server.sendChat(`!${t} - ${this.server.commands[t].help}`,e.id)});this.server.commands[t]?(this.server.sendChat(`Help for !${t}:`,e.id),this.server.commands[t].usage.forEach(t=>{this.server.sendChat(t,e.id)})):this.server.sendChat(`Command !${t} does not exist`,e.id)}},hooks:{onPlayerJoin:["greet"]},commands:{help:{help:"display this message - say !help [command] to learn about command usage (e.g. !help help)",usage:["!help - list all commands","!help [command] - learn about specific command usage (e.g. !help help)"]}}}},function(e,t){e.exports={plugin:class{constructor(e){this.server=e,this.readyPlayers=new Set}checkGameRunning(e){return!!this.server.gameStarted&&(this.server.sendChat("Game is already running!",e.id),!0)}checkGameStart(){const{players:e}=this.server;if(!this.server.gameStarted&&e.length&&e.every(e=>this.readyPlayers.has(e.id))){if(e.length%2==1)return void this.server.sendChat("All players ready but teams would be uneven. Waiting.");this.server.startGame()}}ready(e){this.checkGameRunning(e)||(this.readyPlayers.add(e.id),this.server.sendChat(`${e.name} is ready!`),this.waiting(),this.checkGameStart())}notready(e){this.checkGameRunning(e)||(this.readyPlayers.delete(e.id),this.server.sendChat(`${e.name} is not ready!`),this.waiting())}waiting(e){if(this.checkGameRunning(e))return;const t=this.server.players.filter(e=>!this.readyPlayers.has(e.id));t.length>0?this.server.sendChat(`Still waiting for ${t.map(e=>e.name).join(", ")}`,e):this.server.sendChat("Everyone is ready!",e)}playerLeft(e){this.readyPlayers.delete(e.id),this.checkGameStart()}gameStopped(){this.readyPlayers.clear()}},hooks:{onPlayerLeave:["playerLeft"],onGameStop:["gameStopped"]},commands:{ready:{help:"set your status to ready",usage:["!ready - mark yourself as ready to start a match"]},notready:{help:"set your status to not ready",usage:["!notready - mark yourself as not ready to start a match"]},waiting:{help:"list players that are not ready",usage:["!waiting - list all players which are not ready yet"]}}}},function(e,t){e.exports={plugin:class{constructor(e){this.server=e}addPlayerToMatch(e){this.server.gameStarted&&(this.server.redTeam.has(e.auth)?this.server.room.setPlayerTeam(e.id,1):this.server.blueTeam.has(e.auth)&&this.server.room.setPlayerTeam(e.id,2))}},hooks:{onPlayerJoin:["addPlayerToMatch"]}}},function(e,t){e.exports={plugin:class{constructor(e){this.server=e,this.clearState()}clearState(){this.assistKick={},this.lastKick={},this.goals={red:[],blue:[]}}registerNewKick(e){this.assistKick=this.lastKick,this.lastKick=e}addNewGoal(e){const t=1===e?this.goals.red:this.goals.blue,s=this.server.room.getScores(),r=Math.ceil(s.time);let i=r%60;const o=(r-i)/60;let a;i=String(i).padStart(2,"0"),a=this.lastKick.team!==e?`${this.lastKick.name} (OG) - ${o}:${i}`:this.assistKick.team!==e||this.lastKick.id===this.assistKick.id?`${this.lastKick.name} - ${o}:${i}`:`${this.lastKick.name}, A: ${this.assistKick.name} - ${o}:${i}`,t.push(a),this.assistKick={},this.lastKick={},this.server.sendChat(a)}printScore(){this.server.sendChat(`${this.goals.red.join(", ")} ${this.goals.red.length} - ${this.goals.blue.length} ${this.goals.blue.join(", ")}`)}},hooks:{onGameStart:["clearState"],onPlayerBallKick:["registerNewKick"],onTeamGoal:["addNewGoal"],onTeamVictory:["printScore"]}}},function(e,t){e.exports={plugin:class{constructor(e){this.server=e}startMatch(){}endMatch(){}rejectMatch(){}sendStats(){}register(){}login(e,t,s){const{auth:r}=this.server.players.find(t=>t.id===e.id);this.server.sendChat(`Your auth is ${r}`,e.id)}},hooks:{},commands:{login:{help:"login to stats server",usage:["!login [username] [password] - login to your account"]},register:{help:"register a new account on the stats server",usage:["!register [username] [password] - creates new account on the stats server"]}}}},function(e,t,s){const r=s(10),i=e=>/^[-+]?(\d+|Infinity)$/.test(e)?Number(e):NaN;e.exports={plugin:class{constructor(e){this.server=e,this.voteTime=60}voteEnded(){this.voteInProgress=null}vote(e,t,s){if(this.server.gameStarted)return void this.server.sendChat("Game is in progress, can't vote now!",e.id);if(this.voteInProgress)return void this.server.sendChat("Another vote is already in progress!",e.id);if(!t)return void(this.voteInProgress?this.voteInProgress.writeVoteStats(e):this.server.sendChat("There is no vote in progress.",e.id));const{allowedStadiums:o}=this.server;let a,n;switch(t){case"stadium":if(!o.has(s)){this.server.sendChat(`Stadium name must be one of ${Array.from(o).join(", ")}!`,e.id);break}n=`change stadium to ${s}`,a=()=>this.server.setStadium(s);break;case"time":{const t=i(s);if(Number.isNaN(t)||t<0){this.server.sendChat("Time must be a non-negative integer!",e.id);break}n=`change time limit to ${s}`,a=()=>this.server.setTimeLimit(t);break}case"score":{const t=i(s);if(Number.isNaN(t)||t<0){this.server.sendChat("Score must be a non-negative integer!",e.id);break}n=`change score limit to ${s}`,a=()=>this.server.setScoreLimit(t);break}case"start":n="force start the game",a=()=>this.server.startGame();break;default:return void this.server.sendChat(`Can't vote on ${t}!`,e.id)}this.server.sendChat(`${e.name} started a vote to ${n}!`),this.server.sendChat(`Vote with !yes or !no - ${this.voteTime}s remaining`),this.voteInProgress=new r(this.server,this,e,n,a,this.voteTime)}yes(e){this.voteInProgress?this.voteInProgress.voteYes(e):this.server.sendChat("There's nothing to vote on!",e.id)}no(e){this.voteInProgress?this.voteInProgress.voteNo(e):this.server.sendChat("There's nothing to vote on!",e.id)}stopVote(){this.voteInProgress&&this.voteInProgress.stopVote()}},hooks:{onGameStart:["stopVote"]},commands:{vote:{help:"hold a vote",usage:["!vote - print details of current vote","!vote stadium [stadiumName] - change stadium","!vote time [time] - change time limit","!vote score [score] - change score limit","!vote start - force start game"]},yes:{help:"say yes to current vote",usage:["!yes - agree to current vote"]},no:{help:"say yes to current vote",usage:["!no - disagree with current vote"]}}}},function(e,t){e.exports=class{constructor(e,t,s,r,i,o){this.server=e,this.voteManager=t,this.actionDescription=r,this.votedYes=new Set([s.id]),this.votedNo=new Set,this.onSuccess=i,this.voteTimeout=setTimeout(()=>{this.server.sendChat("Voting time elapsed!"),this.stopVote()},1e3*o),this.checkVote()}stopVote(){clearTimeout(this.voteTimeout),this.voteManager.voteEnded()}checkVote(){const{players:e}=this.server;this.votedYes.size>e.length/2?(this.server.sendChat(`Voted to ${this.actionDescription}`),this.onSuccess()):this.votedNo.size>e.length/2&&this.server.sendChat(`Voted to not ${this.actionDescription}`),this.stopVote()}writeVoteStats(e){this.server.sendChat(`Vote to ${this.actionDescription} - Y: ${this.votedYes.size} / N: ${this.votedNo.size}`,e)}voteYes(e){this.votedYes.has(e.id)||(this.votedYes.add(e.id),this.writeVoteStats(),this.checkVote())}voteNo(e){this.votedNo.has(e.id)||(this.votedNo.add(e.id),this.writeVoteStats(),this.checkVote())}playerLeft(e){this.votedYes.delete(e.id),this.votedNo.delete(e.id),this.checkVote()}}}])}const script=document.createElement("script");script.textContent="("+main.toString()+")();",document.body.appendChild(script);